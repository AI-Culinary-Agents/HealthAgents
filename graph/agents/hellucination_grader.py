import json
import os
from graph import AgentState, model
from langchain_core.messages import SystemMessage
from prompts import HALLUCINATION_GRADER_PROMPT
import re
def reviewer_node(state: AgentState, use_saved_data: bool = True):
    directory = os.environ.get("REVIEW_DATA_DIR", "tests/review_save")
    filename = os.path.join(directory, "review_results.json")
    
    if not os.path.exists(directory):
        os.makedirs(directory)
    
    # Use saved data if available
    if use_saved_data and os.path.exists(filename):
        print("From saved data!")
        with open(filename, 'r') as file:
            saved_data = json.load(file)
            return {"review": saved_data["review"], "percentage_true": saved_data["percentage_true"]}
        
    # Combine content and generated text for the prompt
    content = "\n\n".join(state['content'] or [])
    messages = [
        SystemMessage(content=HALLUCINATION_GRADER_PROMPT.format(content=content, generated=state['generated']))
    ]
    response = model.invoke(messages)
    print(response.content)
    print('-------------------')
    # Process the response
    assessments = response.content.split("\n")
    
    # Use regex to detect "true" and "false" in assessments
    true_count = len([assessment for assessment in assessments if re.search(r'\btrue\b', assessment, re.IGNORECASE)])
    total_count = len(assessments)
    percentage_true = (true_count / total_count) * 100 if total_count > 0 else 0
    
    # Save the review results and the percentage result
    with open(filename, 'w') as file:
        json.dump({"review": assessments, "percentage_true": percentage_true}, file)
    
    if percentage_true >= 55:
       print("---VALID---")
       return {"review": assessments, "percentage_true": percentage_true}
    else:
        return "Invalid"
    

state = AgentState(
    task="I want to eat healthy and lose weight but I like pizza and donuts. I have a preference for greasy meals and I'm allergic to nuts and bananas.",
    plan="**Weekly Meal Plan:**\n\n**Day 1:**\n- **Breakfast:** Greek yogurt with mixed berries and a sprinkle of chia seeds.\n  - *Note:* Greek yogurt provides protein and probiotics, while berries offer antioxidants and fiber.\n- **Lunch:** Quinoa salad with roasted vegetables (bell peppers, zucchini, cherry tomatoes) and a lemon vinaigrette.\n  - *Note:* Quinoa is a great source of plant-based protein and fiber, while roasted vegetables add flavor and nutrients.\n- **Dinner:** Lentil and vegetable stir-fry with brown rice.\n  - *Note:* Lentils are high in protein and fiber, and the stir-fry provides a variety of vegetables for vitamins and minerals.\n\n**Day 2:**\n- **Breakfast:** Avocado toast on whole grain bread with a side of sliced tomatoes.\n  - *Note:* Avocado is rich in healthy fats and fiber, while whole grain bread offers complex carbohydrates.\n- **Lunch:** Chickpea and vegetable curry with a side of steamed broccoli.\n  - *Note:* Chickpeas are a good source of protein and fiber, and the curry provides flavorful spices and vegetables.\n- **Dinner:** Stuffed bell peppers with quinoa, black beans, corn, and salsa.\n  - *Note:* Bell peppers are packed with vitamins, and the quinoa and black beans offer a complete protein source.\n\n**Day 3:**\n- **Breakfast:** Smoothie bowl made with spinach, mango, and coconut milk, topped with granola.\n  - *Note:* Spinach adds nutrients, mango provides natural sweetness, and coconut milk offers healthy fats.\n- **Lunch:** Spinach and feta stuffed mushrooms with a side salad.\n  - *Note:* Mushrooms are low in calories and high in nutrients, while feta adds flavor and protein.\n- **Dinner:** Vegetable stir-fried noodles with tofu.\n  - *Note:* Tofu is a good source of plant-based protein, and the vegetables add color and texture.\n\n**Day 4:**\n- **Breakfast:** Oatmeal topped with sliced strawberries and a drizzle of honey.\n  - *Note:* Oatmeal is a filling breakfast option, and strawberries provide vitamin C and antioxidants.\n- **Lunch:** Caprese salad with fresh mozzarella, tomatoes, basil, and balsamic glaze.\n  - *Note:* Mozzarella offers protein, while tomatoes and basil add freshness and flavor.\n- **Dinner:** Eggplant parmesan with a side of mixed greens salad.\n  - *Note:* Eggplant is a low-calorie vegetable, and the salad adds fiber and nutrients.\n\n**Day 5:**\n- **Breakfast:** Whole grain pancakes with maple syrup and a side of fresh fruit.\n  - *Note:* Whole grain pancakes offer complex carbs, while fruit adds natural sweetness and vitamins.\n- **Lunch:** Lentil soup with a side of whole grain bread.\n  - *Note:* Lentils are high in protein and fiber, making them a filling and nutritious choice.\n- **Dinner:** Zucchini noodles with marinara sauce and grilled portobello mushrooms.\n  - *Note:* Zucchini noodles are a low-carb alternative, and portobello mushrooms provide a meaty texture.\n\n**Day 6:**\n- **Breakfast:** Chia seed pudding with sliced peaches and a sprinkle of cinnamon.\n  - *Note:* Chia seeds are rich in omega-3 fatty acids and fiber, while peaches offer vitamins and minerals.\n- **Lunch:** Black bean and corn salad with a lime-cilantro dressing.\n  - *Note:* Black beans are a good source of plant-based protein, and the salad is refreshing and flavorful.\n- **Dinner:** Vegetable and tofu stir-fry with quinoa.\n  - *Note:* Tofu provides protein, while the stir-fry offers a variety of vegetables for nutrients.\n\n**Day 7:**\n- **Breakfast:** Scrambled eggs with saut\u00e9ed spinach and whole grain toast.\n  - *Note:* Eggs are a good source of protein, and spinach adds vitamins and minerals.\n- **Lunch:** Roasted vegetable wrap with hummus in a whole wheat tortilla.\n  - *Note:* Roasted vegetables provide flavor and nutrients, while hummus adds protein and creaminess.\n- **Dinner:** Cauliflower crust pizza with assorted vegetables and a side salad.\n  - *Note:* Cauliflower crust is a low-carb alternative, and the vegetables offer a variety of nutrients.\n\n**Notes:**\n- Stay hydrated throughout the day by drinking plenty of water.\n- Portion control is key for weight loss, so be mindful of serving sizes.\n- Incorporate a variety of colorful fruits and vegetables for a range of nutrients.\n- Consider incorporating physical activity into your routine for overall health and weight loss.", 
    generated="**7-Day Healthy Meal Plan**\n\n**Day 1:**\n- **Breakfast:** Greek Yogurt Parfait\n  - *Ingredients:* \n    - 1 cup Greek yogurt\n    - 1/2 cup mixed berries\n    - 1 tbsp chia seeds\n  - *Instructions:* In a bowl, layer Greek yogurt, mixed berries, and chia seeds.\n  - *Nutritional Information:* 327 calories, 18g protein, 41g carbohydrates, 11g fat, 8g fiber\n- **Snack:** Carrot Sticks with Hummus\n  - *Ingredients:* \n    - 1 medium carrot, sliced\n    - 2 tbsp hummus\n  - *Nutritional Information:* 80 calories, 2g protein, 12g carbohydrates, 4g fat, 3g fiber\n- **Lunch:** Quinoa Salad\n  - *Ingredients:* \n    - 1/2 cup quinoa, cooked\n    - Assorted roasted vegetables\n    - Lemon vinaigrette\n  - *Instructions:* Mix quinoa with roasted vegetables and drizzle with lemon vinaigrette.\n  - *Nutritional Information:* 396 calories, 41g protein, 18g carbohydrates, 18g fat, 6g fiber\n- **Snack:** Apple Slices with Almond Butter\n  - *Ingredients:* \n    - 1 medium apple, sliced\n    - 1 tbsp almond butter\n  - *Nutritional Information:* 192 calories, 7g protein, 31g carbohydrates, 5g fat, 6g fiber\n- **Dinner:** Lentil and Vegetable Stir-Fry with Brown Rice\n  - *Ingredients:* \n    - 1/2 cup lentils, cooked\n    - Assorted vegetables\n    - Brown rice\n  - *Instructions:* Stir-fry cooked lentils and vegetables, serve over brown rice.\n  - *Nutritional Information:* 399 calories, 34g protein, 57g carbohydrates, 4g fat, 10g fiber\n- **Snack:** Air-Popped Popcorn\n  - *Ingredients:* \n    - 3 cups air-popped popcorn\n    - 1 tsp olive oil\n    - Seasonings of choice\n  - *Nutritional Information:* 102 calories, 3g protein, 20g carbohydrates, 2g fat, 4g fiber\n- *Daily Totals:* 1,496 calories, 105g protein, 179g carbohydrates, 44g fat, 31g fiber\n\n**Day 2:**\n- **Breakfast:** Avocado Toast\n  - *Ingredients:* \n    - 1 slice whole grain bread, toasted\n    - 1/2 avocado, mashed\n    - Sliced tomatoes\n  - *Instructions:* Spread mashed avocado on toast, top with sliced tomatoes.\n  - *Nutritional Information:* 280 calories, 6g protein, 30g carbohydrates, 16g fat, 9g fiber\n- **Lunch:** Chickpea and Vegetable Curry\n  - *Ingredients:* \n    - 1/2 cup chickpeas, cooked\n    - Assorted vegetables\n    - Curry sauce\n  - *Instructions:* Combine chickpeas, vegetables, and curry sauce in a pan, simmer until cooked.\n  - *Nutritional Information:* 380 calories, 15g protein, 60g carbohydrates, 10g fat, 12g fiber\n- **Dinner:** Stuffed Bell Peppers\n  - *Ingredients:* \n    - Bell peppers\n    - Quinoa, black beans, corn, salsa mixture\n  - *Instructions:* Stuff bell peppers with quinoa mixture, bake until peppers are tender.\n  - *Nutritional Information:* 420 calories, 18g protein, 75g carbohydrates, 6g fat, 12g fiber\n- *Daily Totals:* 1,080 calories, 69g protein, 165g carbohydrates, 32g fat, 33g fiber\n\n**Day 3:**\n- **Breakfast:** Spinach Mango Smoothie Bowl\n  - *Ingredients:* \n    - 1 cup spinach\n    - 1/2 cup mango\n    - 1/2 cup coconut milk\n    - Granola\n  - *Instructions:* Blend spinach, mango, and coconut milk until smooth, top with granola.\n  - *Nutritional Information:* 320 calories, 7g protein, 50g carbohydrates, 12g fat, 8g fiber\n- **Lunch:** Spinach and Feta Stuffed Mushrooms\n  - *Ingredients:* \n    - Mushrooms\n    - Spinach, feta mixture\n  - *Instructions:* Stuff mushrooms with spinach and feta mixture, bake until mushrooms are cooked.\n  - *Nutritional Information:* 250 calories, 12g protein, 15g carbohydrates, 16g fat, 4g fiber\n- **Dinner:** Vegetable Stir-Fried Noodles with Tofu\n  - *Ingredients:* \n    - Vegetable noodles\n    - Tofu, stir-fry sauce\n  - *Instructions:* Stir-fry vegetable noodles and tofu with sauce until heated through.\n  - *Nutritional Information:* 380 calories, 18g protein, 60g carbohydrates, 10g fat, 8g fiber\n- *Daily Totals:* 1,250 calories, 67g protein, 175g carbohydrates, 38g fat, 20g fiber\n\n**Day 4:**\n- **Breakfast:** Strawberry Oatmeal\n  - *Ingredients:* \n    - 1/2 cup oats, cooked\n    - Sliced strawberries\n    - Drizzle of honey\n  - *Instructions:* Top cooked oats with sliced strawberries and honey.\n  - *Nutritional Information:* 280 calories, 7g protein, 50g carbohydrates, 6g fat, 8g fiber\n- **Lunch:** Caprese Salad\n  - *Ingredients:* \n    - Fresh mozzarella, tomatoes, basil\n    - Balsamic glaze\n  - *Instructions:* Arrange mozzarella, tomatoes, and basil on a plate, drizzle with balsamic glaze.\n  - *Nutritional Information:* 320 calories, 18g protein, 10g carbohydrates, 24g fat, 2g fiber\n- **Dinner:** Eggplant Parmesan\n  - *Ingredients:* \n    - Eggplant slices\n    - Marinara sauce, mozzarella\n  - *Instructions:* Layer eggplant slices with marinara sauce and mozzarella, bake until cheese is melted.\n  - *Nutritional Information:* 400 calories, 20g protein, 40g carbohydrates, 18g fat, 10g fiber\n- *Daily Totals:* 1,000 calories, 45g protein, 100g carbohydrates, 48g fat, 20g fiber\n\n**Day 5:**\n- **Breakfast:** Whole Grain Pancakes with Fruit\n  - *Ingredients:* \n    - 2 whole grain pancakes\n    - Maple syrup\n    - Fresh fruit\n  - *Instructions:* Serve pancakes with maple syrup and fresh fruit.\n  - *Nutritional Information:* 350 calories, 8g protein, 60g carbohydrates, 10g fat, 6g fiber\n- **Lunch:** Lentil Soup with Whole Grain Bread\n  - *Ingredients:* \n    - Lentil soup\n    - 1 slice whole grain bread\n  - *Instructions:* Heat lentil soup, serve with whole grain bread.\n  - *Nutritional Information:* 320 calories, 15g protein, 50g carbohydrates, 6g fat, 12g fiber\n- **Dinner:** Zucchini Noodles with Marinara Sauce\n  - *Ingredients:* \n    - Zucchini noodles\n    - Marinara sauce\n    - Grilled portobello mushrooms\n  - *Instructions:* Toss zucchini noodles with marinara sauce, serve with grilled portobello mushrooms.\n  - *Nutritional Information:* 330 calories, 12g protein, 40g carbohydrates, 16g fat, 8g fiber\n- *Daily Totals:* 1,000 calories, 35g protein, 150g carbohydrates, 32g fat, 26g fiber\n\n**Day 6:**\n- **Breakfast:** Chia Seed Pudding with Peaches\n  - *Ingredients:* \n    - Chia seed pudding\n    - Sliced peaches\n    - Cinnamon\n  - *Instructions:* Top chia seed pudding with sliced peaches and cinnamon.\n  - *Nutritional Information:* 280 calories, 6g protein, 40g carbohydrates, 12g fat, 10g fiber\n- **Lunch:** Black Bean and Corn Salad\n  - *Ingredients:* \n    - Black beans, corn\n    - Lime-cilantro dressing\n  - *Instructions:* Mix black beans and corn with lime-cilantro dressing.\n  - *Nutritional Information:* 300 calories, 15g protein, 45g carbohydrates, 8g fat, 10g fiber\n- **Dinner:** Vegetable and Tofu Stir-Fry with Quinoa\n  - *Ingredients:* \n    - Assorted vegetables, tofu\n    - Quinoa\n  - *Instructions:* Stir-fry vegetables and tofu, serve over quinoa.\n  - *Nutritional Information:* 370 calories, 18g protein, 50g carbohydrates, 12g fat, 10g fiber\n- *Daily Totals:* 950 calories, 39g protein, 135g carbohydrates, 32g fat, 30g fiber\n\n**Day 7:**\n- **Breakfast:** Scrambled Eggs with Spinach and Whole Grain Toast\n  - *Ingredients:* \n    - 2 eggs, scrambled\n    - Handful of spinach\n    - 1 slice whole grain toast\n  - *Instructions:* Cook scrambled eggs with spinach, serve with whole grain toast.\n  - *Nutritional Information:* 320 calories, 18g protein, 30g carbohydrates, 14g fat, 6g fiber\n- **Lunch:** Roasted Vegetable Wrap with Hummus\n  - *Ingredients:* \n    - Roasted vegetables\n    - Hummus\n    - Whole wheat tortilla\n  - *Instructions:* Fill tortilla with roasted vegetables and hummus, wrap it up.\n  - *Nutritional Information:* 350 calories, 10g protein, 50g carbohydrates, 12g fat, 10g fiber\n- **Dinner:** Cauliflower Crust Pizza with Salad\n  - *Ingredients:* \n    - Cauliflower crust pizza with assorted vegetables\n    - Side salad\n  - *Instructions:* Bake cauliflower crust pizza, serve with a side salad.\n  - *Nutritional Information:* 400 calories, 15g protein, 45g carbohydrates, 18g fat, 8g fiber\n- *Daily Totals:* 1,070 calories, 43g protein, 125g carbohydrates, 44g fat, 24g fiber\n\n**Notes:**\n- Remember to drink plenty of water throughout the day.\n- Be mindful of portion sizes for weight loss.\n- Include a variety of colorful fruits and vegetables for a range of nutrients.\n- Consider adding physical activity to your routine for overall health and weight loss.",
    content=["Healthy Pita Pizza. Margherita Flatbread. Pizza can be much healthier if you use the right toppings. Check my list of 45 healthy pizza toppings to enjoy and ones to avoid.", "Place a piece of oiled parchment paper on top of the dough ball (oiled side onto the dough) and roll it into a 10-inch circle. The parchment paper prevents the raw dough from sticking to the paper. Freeze the pizza base while making the yogurt dip. In a small bowl, stir yogurt, maple syrup, and cinnamon.", "How to Meal Plan for a Healthy, Balanced Diet\nPlanning healthy meals isn't difficult, but if you're not used to it, the planning can take a little practice. Download the 1-Week Healthy and Balanced Meal Plan\nDownload the Meal Plan\nDay 1\nBreakfast\nMacronutrients: approximately 327 calories, 18 grams protein, 41 grams carbohydrates, and 11 grams fat\nSnack\nMacronutrients: 324 calories, 14 grams protein, 62 grams carbohydrates, 4 grams fat\nLunch\nMacronutrients: 396 calories, 41 grams protein, 18 grams carbohydrates, 18 grams fat\nSnack\nMacronutrients: 192 calories, 7 grams protein, 31 grams carbohydrates, 5 grams fat\nDinner\nMacronutrients: 399 calories, 34 grams protein, 57 grams carbohydrates, 4 grams fat\nSnack\nMacronutrients: 302 calories, 3 grams protein, 49 grams carbohydrates, 12 grams fat\nDaily Totals: 1,940 calories, 117 grams protein, 258 grams carbohydrates, 55 grams fat\nNote that beverages are not included in this meal plan."],
    revision_number=0, 
    max_revisions=2
)

print(reviewer_node(state, use_saved_data=False))